---
title: "skysparkEDA_0103"
author: "Yujie Xu"
date: "1/3/2019"
output:
  powerpoint_presentation: default
  ioslides_presentation: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

## Tasks completed

- Finished downloading 2018 sparks rules data for all buildings
- Summary statistics of the above

---

## Presence of rule data

:::::::::::::: {.columns}
::: {.column}
According to the skyspark interface, there are 153 buildings with GSALink. Among them 89 buildings have spark rules triggered in 2018.
:::
::: {.column}
```{r buildingSet}
library("dplyr")
library("readxl")
library("ggplot2")
library("purrr")
gsalink_building =
  readxl::read_excel("../data-raw/list_of_gsalink_buildings.xlsx",
                     sheet=2) %>%
  tibble::as.tibble() %>%
  dplyr::mutate(`building`=substr(`spark_entry`, 1, 8)) %>%
  dplyr::select(-`spark_entry`) %>%
  {.}
to_print = gsalink_building %>%
  dplyr::group_by(`status`) %>%
  dplyr::summarise(`building count` = n()) %>%
  {.}
knitr::kable(to_print)
```
:::
::::::::::::::

---

# 2018 Rule data by building

---

<!-- result='asis' makes kable print look normal -->
```{r rule, results='asis'}
library("dplyr")
library("ggplot2")
dfrule = readr::read_csv("../data-raw/rule_summary_with_na.csv") %>%
  tibble::as.tibble() %>%
  {.}
sumByBuilding = dfrule %>%
  dplyr::group_by(`building`) %>%
  summarise(`# rules`=n(), count=sum(count),
            `total cost`=sum(Cost),
            `total duration`=sum(`duration_hour`)) %>%
  dplyr::ungroup() %>%
  {.}
rowPerPage = 12
numPages = floor(nrow(sumByBuilding) / rowPerPage)
# for (i in 1:(numPages)) {
#   tmp <- sumByBuilding %>%
#     dplyr::arrange(desc(`total cost`)) %>%
#     slice((i * rowPerPage):((i + 1) * rowPerPage)) %>%
#     knitr::kable(format.args=list(big.mark = ','), digits = 1) %>%
#     {.}
#   print(tmp)
# }
```

# 2018 Rule data top 10 by number of buildings affected

```{r ruleMostBuilding}
library("flextable")
sumByRule = dfrule %>%
  dplyr::group_by(`rule`) %>%
  summarise(`# buildings`=n(), count=sum(count), `total cost`=sum(Cost), `total duration`=sum(`duration_hour`)) %>%
  dplyr::ungroup() %>%
  {.}
sumByRule %>%
  dplyr::select(`rule`, `# buildings`) %>%
  dplyr::arrange(desc(`# buildings`)) %>%
  head(n=10) %>%
  # knitr::kable(format.args=list(big.mark = ','), caption = "2018 Rule data top 10 by number of buildings affected")
  knitr::kable(format.args=list(big.mark = ','))
```

---

# 2018 Rule data top 10 by total duration (hour)

```{r ruleMostDuration}
sumByRule %>%
  dplyr::select(`rule`, `total duration`) %>%
  dplyr::arrange(desc(`total duration`)) %>%
  head(n=10) %>%
  knitr::kable(format.args=list(big.mark = ','))
```

---

# 2018 Rule data top 10 by highest cost

```{r ruleMostCost}
sumByRule %>%
  dplyr::select(`rule`, `total cost`) %>%
  dplyr::arrange(desc(`total cost`)) %>%
  head(n=10) %>%
  knitr::kable(format.args=list(big.mark = ','), caption="2018 Rule data top 10 by highest cost")
```

# Rankings using the same three criteria above but excluding sensor or data related rules: "Missing Data", "Sensor Out Of Range", "Sensor Failure", and "Bad Energy Data"

---

```{r ruleMostBuildingFilter}
rulesToExclude = c("Missing Data", "Sensor Out Of Range", "Sensor Failure", "Bad Energy Data")
top10_nbuilding = sumByRule %>%
  dplyr::select(`rule`, `# buildings`) %>%
  dplyr::filter(!(`rule` %in% rulesToExclude)) %>%
  dplyr::arrange(desc(`# buildings`)) %>%
  head(n=10) %>%
  {.}
top10_nbuilding %>%
  knitr::kable(format.args=list(big.mark = ','), caption="2018 Rule data top 10 by # buildings affected (excluding data error)")
```

---

```{r ruleMostDurationFilter}
top10_dur = sumByRule %>%
  dplyr::select(`rule`, `total duration`) %>%
  dplyr::filter(!(`rule` %in% rulesToExclude)) %>%
  dplyr::arrange(desc(`total duration`)) %>%
  head(n=10) %>%
  {.}
top10_dur %>%
  knitr::kable(format.args=list(big.mark = ','), caption="2018 Rule data top 10 by total duration (excluding data error)")
```

---

```{r ruleMostCostFilter}
top10_cost = sumByRule %>%
  dplyr::select(`rule`, `total cost`) %>%
  dplyr::filter(!(`rule` %in% rulesToExclude)) %>%
  dplyr::arrange(desc(`total cost`)) %>%
  head(n=10) %>%
  {.}
top10_cost %>%
  knitr::kable(format.args=list(big.mark = ','), caption="2018 Rule data top 10 by highest cost (excluding data error)")
```

# 20 Rules show up in at least one of the criteria, and 3 Rules show up in all three criteria

---

## 20 Rules show up in at least one of the criteria

\scriptsize
```{r distinctRules}
list(top10_nbuilding$rule, top10_dur$rule, top10_cost$rule) %>%
  reduce(union) %>%
  sort() %>%
  print()
```
\normalsize

---

## 3 Rules show up in all three criteria

```{r commonRules}
list(top10_nbuilding$rule, top10_dur$rule, top10_cost$rule) %>%
  reduce(intersect) %>%
  sort() %>%
  print()
```